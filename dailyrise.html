<html>

<head>
    <title id="title">COVID statewise daily rise</title>

    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

    <script type="text/javascript" src="./MDB/js/jquery.min.js"></script>
    <script type="text/javascript" src="./MDB/js/addons/datatables.min.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>

    <link href="./MDB/css/style.css" rel="stylesheet">
    <link href="./MDB/css/mdb.css" rel="stylesheet">
    <link href="./MDB/css/bootstrap.min.css" rel="stylesheet">
    <link href="./MDB/css/addons/datatables.min.css" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        #tablediv_wrapper {
            width: 80%;
            padding-left: 10%;
        }

        #loading {
            width: 200px;
            left: calc(50% - 100px);
            top: calc(50% - 100px);
            position: absolute;
        }
    </style>
</head>

<body>
    <div class="containter">
        <p>Data as of: <span id="date"></span></p>
        <table id="tablediv" class="table table-striped table-bordered table-sm" cellspacing="0" width="80%"
            style="display: none;">
            <thead>
                <tr>
                    <th class="th-sm">State
                    </th>
                    <th class="th-sm">Reported
                    </th>
                    <th class="th-sm">Recovered
                    </th>
                    <th class="th-sm">Deceased
                    </th>
                    <th class="th-sm">Active
                    </th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <img src="./loading.gif" id="loading" style="display: block;" />
    </div>
</body>

<script>
    const STATES = ["AN", "AP", "AR", "AS", "BR", "CH", "CT", "DL", "DN", "GA", "GJ", "HP", "HR", "JH", "JK", "KA", "KL", "LA", "MH", "ML", "MN", "MP", "MZ", "NL", "OR", "PB", "PY", "RJ", "SK", "TG", "TN", "TR", "UP", "UT", "WB"];
    const stateNames = {
        "AN": "Andaman & Nicobar",
        "AP": "Andhra Pradesh",
        "AR": "Arunachal Pradesh",
        "AS": "Assam",
        "BR": "Bihar",
        "CH": "Chandigarh",
        "CT": "Chattisgarh",
        "DL": "New Delhi",
        "DN": "Dadra and Nagar Haveli and Daman and Diu",
        "GA": "Goa",
        "GJ": "Gujarat",
        "HP": "Himachal Pradesh",
        "HR": "Haryana",
        "JH": "Jharkhand",
        "JK": "Jammu & Kashmir",
        "KA": "Karnataka",
        "KL": "Kerala",
        "LA": "Ladakh",
        "MH": "Maharashtra",
        "ML": "Meghalaya",
        "MN": "Manipur",
        "MP": "Madhya Pradesh",
        "MZ": "Mizoram",
        "NL": "Naga Land",
        "OR": "Odisha",
        "PB": "Punjab",
        "PY": "Puducherry",
        "RJ": "Rajasthan",
        "SK": "Sikkim",
        "TG": "Telangana",
        "TN": "Tamil Nadu",
        "TR": "Tripura",
        "UP": "Uttar Pradesh",
        "UT": "Uttarakhand",
        "WB": "West Bengal"
    }
    const ONE_DAY = 24 * 3600 * 1000;

    const toTableRow = (state, reported, recovered, deceased, active) => `<tr><td>${stateNames[state]}</td><td>${reported}</td><td>${recovered}</td><td>${deceased}</td><td>${active}</td></tr>`;

    const toURL = (date) => {
        const [dd, mm, yyyy] = [date.getDate(), date.getMonth() + 1, date.getFullYear()];
        document.getElementById("date").innerText = `${dd}-${mm}-${yyyy}`;
        document.getElementById("title").innerText = `${dd} -${mm} -${yyyy} COVID statewise daily rise`;
        return `https://api.covid19india.org/v4/data-${yyyy}-${mm.toString().padStart(2, 0)}-${dd.toString().padStart(2, 0)}.json`;
    }

    const fetchData = (date) => fetch(toURL(date)).then(z => z.json()).catch(() => fetchData(new Date(new Date(date).getTime() - ONE_DAY)));

    // const url = toURL(yesterday);
    // const urlDB4 = toURL(dayBefore);

    fetchData(new Date()).then(json => {
        const html = STATES.map(state => {
            const { confirmed, deceased, recovered } = json[state].delta;
            const active = +confirmed - (+deceased || 0) - (+recovered || 0);
            return toTableRow(state, confirmed || 0, recovered || 0, deceased || 0, active || 0);
        }).join('');

        $("#tablediv>tbody").html(html);
        $('#tablediv').DataTable();
        $('.dataTables_length').addClass('bs-select');
        document.getElementById("loading").setAttribute("style", "display: none");
        document.getElementById("tablediv").setAttribute("style", "display: block");
    });



</script>

</html>