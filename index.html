<html>

<head>
    <title>COVID statewise active cases</title>
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        #chartdiv {
            width: 100%;
            height: 500px;
        }

        #loading {
            width: 200px;
            left: calc(50% - 100px);
            top: calc(50% - 100px);
            position: absolute;
        }
    </style>
</head>

<body>
    <div id="chartdiv" style="display: none;"></div>
    <img src="./loading.gif" id="loading" style="display: block;" />
</body>

<script>
    const CATAGORY_X = "active", CATAGORY_Y = "state";

    const STATES = ["AN", "AP", "AR", "AS", "BR", "CH", "CT", "DL", "DN", "GA", "GJ", "HP", "HR", "JH", "JK", "KA", "KL", "LA", "MH", "ML", "MN", "MP", "MZ", "NL", "OR", "PB", "PY", "RJ", "SK", "TG", "TN", "TR", "UP", "UT", "WB"];
</script>

<script>
    am4core.useTheme(am4themes_animated);

    var chart = am4core.create("chartdiv", am4charts.XYChart);
    chart.padding(40, 40, 40, 40);

    // chart.numberFormatter.bigNumberPrefixes = [
    //     { "number": 1e+3, "suffix": "K" },
    //     { "number": 1e+6, "suffix": "M" },
    //     { "number": 1e+9, "suffix": "B" }
    // ];

    fetch("https://api.covid19india.org/v4/data-all.json").then(z => z.json()).then(json => {

        const allData = {

        };

        for (const date of Object.keys(json)) {
            allData[date] = [];
            for (const state of STATES) {
                if (json[date][state] == undefined) {
                    json[date][state] = { total: { confirmed: 0, deceased: 0, recovered: 0, tested: 0 } };
                }

                const { confirmed, deceased, recovered, tested } = json[date][state].total;
                let active = +confirmed - (+deceased || 0) - (+recovered || 0);

                allData[date].push({
                    state,
                    active
                })
            }
        }


        var label = chart.plotContainer.createChild(am4core.Label);
        label.x = am4core.percent(97);
        label.y = am4core.percent(95);
        label.horizontalCenter = "right";
        label.verticalCenter = "middle";
        label.dx = -15;
        label.fontSize = 50;

        var playButton = chart.plotContainer.createChild(am4core.PlayButton);
        playButton.x = am4core.percent(97);
        playButton.y = am4core.percent(95);
        playButton.dy = -2;
        playButton.verticalCenter = "middle";
        playButton.events.on("toggled", function (event) {
            if (event.target.isActive) {
                play();
            }
            else {
                stop();
            }
        })

        var stepDuration = 1000, MAX_Y_COUNT = 10;

        var categoryAxis = chart.yAxes.push(new am4charts.CategoryAxis());
        categoryAxis.renderer.grid.template.location = 0;
        categoryAxis.dataFields.category = CATAGORY_Y;
        categoryAxis.renderer.minGridDistance = 1;
        categoryAxis.renderer.inversed = true;
        categoryAxis.renderer.grid.template.disabled = true;

        var valueAxis = chart.xAxes.push(new am4charts.ValueAxis());
        valueAxis.min = 0;
        valueAxis.rangeChangeEasing = am4core.ease.linear;
        valueAxis.rangeChangeDuration = stepDuration;
        valueAxis.extraMax = 0.1;

        var series = chart.series.push(new am4charts.ColumnSeries());
        series.dataFields.categoryY = CATAGORY_Y;
        series.dataFields.valueX = CATAGORY_X;
        series.tooltipText = "{valueX.value}"
        series.columns.template.strokeOpacity = 0;
        series.columns.template.column.cornerRadiusBottomRight = 5;
        series.columns.template.column.cornerRadiusTopRight = 5;
        series.interpolationDuration = stepDuration;
        series.interpolationEasing = am4core.ease.linear;

        var labelBullet = series.bullets.push(new am4charts.LabelBullet())
        labelBullet.label.horizontalCenter = "right";
        labelBullet.label.text = "{values.valueX.workingValue.formatNumber('#.')}";

        labelBullet.label.textAlign = "end";
        labelBullet.label.dx = -10;

        chart.zoomOutButton.disabled = true;

        // as by default columns of the same series are of the same color, we add adapter which takes colors from chart.colors color set
        series.columns.template.adapter.add("fill", function (fill, target) {
            return chart.colors.getIndex(target.dataItem.index);
        });

        const instances = Object.keys(allData);

        let instance = 0;

        label.text = instances[instance].toString();

        var interval;

        function play() {
            interval = setInterval(function () {
                nextInstance();
            }, stepDuration)
            nextInstance();
        }

        function stop() {
            if (interval) {
                clearInterval(interval);
            }
        }

        function nextInstance() {
            instance++

            if (instance >= instances.length) {
                instance = 0;
            }

            var newData = allData[instances[instance]];
            var itemsWithNonZero = 0;

            for (var i = 0; i < chart.data.length; i++) {

                chart.data[i][CATAGORY_X] = newData[i][CATAGORY_X];
                if (chart.data[i][CATAGORY_X] > 0) {
                    itemsWithNonZero++;
                }
            }

            if (instance == 0) {
                series.interpolationDuration = stepDuration / 4;
                valueAxis.rangeChangeDuration = stepDuration / 4;
            }
            else {
                series.interpolationDuration = stepDuration;
                valueAxis.rangeChangeDuration = stepDuration;
            }

            chart.invalidateRawData();
            label.text = instances[instance].toString();

            itemsWithNonZero = Math.min(itemsWithNonZero, MAX_Y_COUNT);

            categoryAxis.zoom({ start: 0, end: itemsWithNonZero / categoryAxis.dataItems.length });
        }

        categoryAxis.sortBySeries = series;

        chart.data = JSON.parse(JSON.stringify(allData[instances[instance]]));
        categoryAxis.zoom({ start: 0, end: 1 / chart.data.length });

        series.events.on("inited", function () {

            document.getElementById("loading").setAttribute("style", "display: none");
            document.getElementById("chartdiv").setAttribute("style", "display: block");
            setTimeout(function () {
                playButton.isActive = true; // this starts interval
            }, 2000)
        })

    })
</script>

</html>